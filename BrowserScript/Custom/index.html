<!DOCTYPE html>
<html>
<head>
<title>Page Title</title>
</head>
<body>

<script src="./KBwasm.js"></script>
<script src="./KBcache.js"></script>
<script src="./KBstorage.js"></script>

<script>

    function stringFromUTF8Array(data)
    {
        const extraByteMap = [ 1, 1, 1, 1, 2, 2, 3, 0 ];
        var count = data.length;
        var str = "";

        for (var index = 0;index < count;)
        {
            var ch = data[index++];
            if (ch & 0x80)
            {
            var extra = extraByteMap[(ch >> 3) & 0x07];
            if (!(ch & 0x40) || !extra || ((index + extra) > count))
                return null;
            
            ch = ch & (0x3F >> extra);
            for (;extra > 0;extra -= 1)
            {
                var chx = data[index++];
                if ((chx & 0xC0) != 0x80)
                return null;
                
                ch = (ch << 6) | (chx & 0x3F);
            }
            }
            
            str += String.fromCharCode(ch);
        }

        return str;
    }

    let storage = new KBstorage("127.0.0.1", 3000);

    function parseExpression(expression_id)
    {
        var parent = document.getElementById(expression_id);
        parent.children["1"].disabled = true;

        var expression = parent.children["0"].innerText;

        storage.ParseExpression(expression).then( data => { 
            
            if ( null != data )
            {
                data.forEach(element => {

                    var child_expression = JSON.stringify(element);
                    
                    var new_element = document.getElementById("empty_expression").cloneNode(true);

                    new_element.hidden = false;
                    new_element.id = child_expression
                    new_element.children["0"].innerText = child_expression;

                    parent.appendChild( new_element );
                });
            }

        } );

        return;
    }

    function getData(expression_id)
    {
        var parent = document.getElementById(expression_id);
        parent.children["2"].disabled = true;

        var expression = parent.children["0"].innerText;

        storage.GetData(expression).then( data => { 
            
            if ( null != data )
                parent.children["3"].innerText = "MIME=" + data.MIME + ", size=" + data.size + ", strVal=" + stringFromUTF8Array(data);

        } );

        return;
    }

</script>

<div id="empty_expression" hidden="true">
    <p></p> 
    <button onclick="parseExpression(this.parentNode.id)">Parse</button>
    <button onclick="getData(this.parentNode.id)">Get Data</button>
</div>


<div id="init">
    <p>{ "cid" : "_book1_" }</p> 
    <button onclick="parseExpression(this.parentNode.id)">Parse</button>
    <button onclick="getData(this.parentNode.id)">Get Data</button>
    <p></p>
</div>

</body>
</html>