<html>
<body>
<script src="pdf2html.js"></script>
<script src="pdf2html_wasm.js"></script>
<script>

function str2ab(str) {
    var buf = new ArrayBuffer(str.length*2); // 2 bytes for each char
    var bufView = new Uint16Array(buf);
    for (var i=0, strLen=str.length; i < strLen; i++) {
        bufView[i] = str.charCodeAt(i);
    }
    return buf;
}


function ab2str(buf) {
  return String.fromCharCode.apply(null, new Uint16Array(buf));
}

var reader = new FileReader();

var filename = "";

reader.onload = displayPDF;

function displayPDF(e)
{
    let pdfBinary = reader.result;
    let arr_arg0 = new Uint8Array(pdfBinary);

    let arg0_pointer = MyWasm._set_arg(0, arr_arg0.length );
    
    let pdf = new Uint8ClampedArray(MyWasm.wasmMemory.buffer, arg0_pointer, arr_arg0.length);

    for (let i = 0; i < pdf.length; i++) {
        pdf[i] = arr_arg0[i];
        console.log(i);
    }

    document.writeln( filename + " - size ", arr_arg0.length, "<br>" );

    document.writeln( "Converting to HTML...<br>" );

    var start = window.performance.now();

    let r = pdf.length;

    if ( MyWasm._exec() )
    {
        let result = [];

        let str_result = "";

        var size = MyWasm._get_result_size();

        document.writeln( "Result size ", size, "<br>" );

        var res_pointer = MyWasm._get_result();
        
        var pResultData = new Uint8ClampedArray(MyWasm.wasmMemory.buffer, res_pointer, size);
        
        for (var i = 0; i < pResultData.length; i++) {
            
            result.push(pResultData[i]);

            if (100 == result.length)
            {
                str_result += ab2str(result);

                result = [];
            }
        }

        if (0 != result.length)
            str_result += ab2str(result);

        var stop = window.performance.now();
        
        document.writeln( "Converting time is: ", stop - start, "ms. <br>" );

        document.writeln(str_result);
    }
}


var MyWasm = new Module (
    { 
        instantiateWasm : function(imports, successCallback)
        {
            WebAssembly.instantiate(new Uint8Array(wasmBinary2), imports).then(function(output) {

                successCallback(output.instance);

            });
        }
    }
);


MyWasm.onRuntimeInitialized = function() {

    document.writeln( "Pdf to HTML converter using WebAssembly<br>" );
    document.writeln( "pdf2html.wasm loaded...<br>" );
    document.writeln( "<input type='file' onchange='reader.readAsArrayBuffer(this.files[0]);'/>");
}

</script>
</body>
</html>