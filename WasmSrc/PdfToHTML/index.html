<html>
<body>
<script src="pdf2html.js"></script>
<script>

function str2ab(str) {
    var buf = new ArrayBuffer(str.length*2); // 2 bytes for each char
    var bufView = new Uint16Array(buf);
    for (var i=0, strLen=str.length; i < strLen; i++) {
        bufView[i] = str.charCodeAt(i);
    }
    return buf;
}


function ab2str(buf) {
  return String.fromCharCode.apply(null, new Uint16Array(buf));
}

function readURL(sender)
{
    displayPDF(sender.files[0].name);
}

function displayPDF(filename)
{
    document.writeln( "<br>Loading...<br>" );

    fetch(filename).then(response => response.arrayBuffer()).then( pdfBinary => { 
    {
        let arr_arg0 = new Uint8Array(pdfBinary);

        let pointer = MyWasm._set_arg(1, arr_arg0.length );
        
        var pdf = new Uint8ClampedArray(MyWasm.wasmMemory.buffer, pointer, arr_arg0.length);

        for (var i = 0; i < pdf.length; i++) {
            pdf[i] = arr_arg0[i];
        }

        document.writeln( filename + " - size ", arr_arg0.length, "<br>" );
    }

    document.writeln( "Converting to HTML...<br>" );

    var start = window.performance.now();

    if ( MyWasm._exec() )
    {
        let result = [];

        let str_result = "";

        var size = MyWasm._get_result_size();

        document.writeln( "Result size ", size, "<br>" );

        var pointer = MyWasm._get_result();
        
        var pResultData = new Uint8ClampedArray(MyWasm.wasmMemory.buffer, pointer, size);
        
        for (var i = 0; i < pResultData.length; i++) {
            
            result.push(pResultData[i]);

            if (100 == result.length)
            {
                str_result += ab2str(result);

                result = [];
            }
        }

        if (0 != result.length)
            str_result += ab2str(result);

        var stop = window.performance.now();
        
        document.writeln( "Converting time is: ", stop - start, "ms. <br>" );

        var w = window.open("", "", "resizable,status,width=640,height=820");
        var d = w.document;
        d.write(str_result);
        d.close();
    }
    else
        document.writeln( "Exacution failed!" );
    } );
}


var MyWasm = new Module (
    { 
        instantiateWasm : function(imports, successCallback)
        {
            fetch('pdf2html.wasm').then(response => response.arrayBuffer()).then( wasmBinary => { 

                WebAssembly.instantiate(new Uint8Array(wasmBinary), imports).then(function(output) {

                    successCallback(output.instance);

                });

            } );
        }
    }
);


MyWasm.onRuntimeInitialized = function() {

    document.writeln( "Pdf to HTML converter using WebAssembly<br>" );
    document.writeln( "pdf2html.wasm loaded...<br>" );
    document.writeln( "<input type='file' onchange='readURL(this);'/>");
}


</script>
</body>
</html>